// ==UserScript==
// @name         Raider.IO <-> WoWProgress + WarcraftLogs Links (SPA compatible)
// @namespace    https://tampermonkey.net/
// @version      1.9
// @description  Ajoute liens croisés entre Raider.IO, WoWProgress et Warcraft Logs, avec support SPA sur Raider.IO
// @match        https://raider.io/characters/*
// @match        https://www.wowprogress.com/character/*
// @grant        none
// ==/UserScript==

(function () {
    'use strict';

    let lastUrl = location.href;

    // --- Parser des URLs ---
    function parseCharacterInfoFromRaiderIO() {
        const match = window.location.pathname.match(/^\/characters\/([^/]+)\/([^/]+)\/(.+)$/);
        if (!match) return null;
        const [, region, realm, name] = match;
        return { region, realm, name };
    }

    function parseCharacterInfoFromWoWProgress() {
        const match = window.location.pathname.match(/^\/character\/([^/]+)\/([^/]+)\/(.+)$/);
        if (!match) return null;
        const [, region, realm, name] = match;
        return { region, realm, name };
    }

    // --- Création d’un lien avec icône (pour Raider.IO) ---
    function createIconLink(url, title) {
        const link = document.createElement('a');
        link.href = url;
        link.title = title;
        link.target = '_blank';
        link.rel = 'noopener';
        link.className = 'slds-avatar slds-avatar--small slds-m-left--large rio-profile-links';
        link.style.backgroundImage = 'url(https://www.wowprogress.com/favicon.ico)';
        link.style.backgroundSize = 'contain';
        link.style.backgroundRepeat = 'no-repeat';
        link.style.backgroundPosition = 'center';
        return link;
    }

    // --- Injecteur pour Raider.IO ---
    function injectIntoRaiderIO() {
        const info = parseCharacterInfoFromRaiderIO();
        if (!info) return;

        const targetUrl = `https://www.wowprogress.com/character/${info.region}/${info.realm}/${info.name}`;

        const tryInject = () => {
            const rightContainer = document.querySelector('header.slds-text-body--large .slds-float--right');
            if (rightContainer && !document.getElementById('wowprogress-link')) {
                const link = createIconLink(targetUrl, 'Voir sur WoWProgress');
                link.id = 'wowprogress-link';
                rightContainer.appendChild(link);
                return true;
            }
            return false;
        };

        // Retry until injected (utile pour SPA)
        const interval = setInterval(() => {
            if (tryInject()) clearInterval(interval);
        }, 300);
    }

    // --- Injecteur pour WoWProgress ---
    function createTextLink(url, text, id) {
        const link = document.createElement('a');
        link.href = url;
        link.textContent = text;
        link.target = '_blank';
        link.rel = 'noopener';
        link.id = id;
        link.style.marginLeft = '5px';
        link.style.fontSize = '0.9em';
        link.style.color = '#00aeff';
        link.style.textDecoration = 'none';
        return link;
    }

    function injectLinksToWoWProgress() {
        const info = parseCharacterInfoFromWoWProgress();
        if (!info) return;

        const raiderUrl = `https://raider.io/characters/${info.region}/${info.realm}/${info.name}`;
        const logsUrl = `https://www.warcraftlogs.com/character/${info.region}/${info.realm}/${info.name}`;

        const interval = setInterval(() => {
            const armoryLink = document.querySelector('a.armoryLink');
            if (armoryLink && !document.getElementById('raiderio-link')) {
                // Raider.IO link
                const sep1 = document.createTextNode(' | ');
                const raiderLink = createTextLink(raiderUrl, 'Raider.IO', 'raiderio-link');

                // Warcraft Logs link
                const sep2 = document.createTextNode(' | ');
                const logsLink = createTextLink(logsUrl, 'WarcraftLogs', 'wcl-link');

                // Insert after (armory)
                const parent = armoryLink.parentNode;
                parent.insertBefore(sep1, armoryLink.nextSibling);
                parent.insertBefore(raiderLink, sep1.nextSibling);
                parent.insertBefore(sep2, raiderLink.nextSibling);
                parent.insertBefore(logsLink, sep2.nextSibling);

                clearInterval(interval);
            }
        }, 300);
    }

    // --- Surveille les changements d’URL pour SPA Raider.IO ---
    function checkUrlChange() {
        if (location.href !== lastUrl) {
            lastUrl = location.href;
            if (location.hostname.includes('raider.io')) {
                injectIntoRaiderIO();
            } else if (location.hostname.includes('wowprogress.com')) {
                injectLinksToWoWProgress();
            }
        }
    }

    // --- Execution initiale ---
    if (location.hostname.includes('raider.io')) {
        injectIntoRaiderIO();
    } else if (location.hostname.includes('wowprogress.com')) {
        injectLinksToWoWProgress();
    }

    // --- Timer de surveillance URL (SPA) ---
    setInterval(checkUrlChange, 500);

})();
